{// 引入标签库 }
<tagLib name="html" />
<include file="Public:header" />
<PHP>
function get_pay_incharge_link($id)
{
	if(M("DealOrder")->where("id=".$id)->getField("pay_status")!=2)
	{
		return "<a href='javascript:void(0);' onclick='pay_incharge(".$id.");'>".l("ORDER_PAID_INCHARGE")."</a>";
	}
}
function get_baofoo_query_link($id,$pid)
{
	if($GLOBALS['db']->getOneCached("SELECT `class_name` FROM ".DB_PREFIX."payment WHERE id=".$pid)=="Baofoo"){
		$payment_notice_id = $GLOBALS['db']->getOne("SELECT id FROM ".DB_PREFIX."payment_notice WHERE order_id=".$id);
		return '<a href="javascript:checkBaofooOrder('.$payment_notice_id.');">查询</a>';
	}
}
function get_sqepay_query_link($id,$pid)
{
	if($GLOBALS['db']->getOneCached("SELECT `class_name` FROM ".DB_PREFIX."payment WHERE id=".$pid)=="Sqepay"){
		$payment_notice_id = $GLOBALS['db']->getOne("SELECT id FROM ".DB_PREFIX."payment_notice WHERE order_id=".$id);
		return '<a href="javascript:checkSqOrder('.$payment_notice_id.');" >查询</a>';
	}
}
function get_bank($bank_id){
	
			switch(bank_id)
		{
		case $bank_id=='ICBC':
		 return '工商银行';
		  break;
		case $bank_id=='BOCSH':
		 return '中国银行';
		  break;
		  case $bank_id=='PSBC':
		 return '邮政储蓄';
		  break;
		  case $bank_id=='CCB':
		 return '建设银行';
		  break;
		  case $bank_id=='ABOC':
		 return '农业银行';
		  break;
		  case $bank_id=='BOCOM':
		 return '交通银行';
		  break;
		  case $bank_id=='CMB':
		 return '招商银行';
		  break;
		   case $bank_id=='CMBC':
		 return '民生银行';
		  break;
		   case $bank_id=='CEB':
		 return '光大银行';
		  break;
		   case $bank_id=='SPDB':
		 return '浦发银行';
		  break;
		   case $bank_id=='CIB':
		 return '兴业银行';
		 case $bank_id=='HXB':
		 return '华夏银行';
		  case $bank_id=='GDB':
		 return '广发银行';
		  break;
		  case $bank_id=='CNCB':
		 return '中信银行';
		  break;
		   case $bank_id=='ABC':
		 return '农业银行';
		  break;
		default:
		 return $bank_id;
		}
			}		
</PHP>
<script type="text/javascript">
	function pay_incharge(id)
	{
		if(confirm("{%CONFIRM_PAY_INCHARGE}"))
		location.href = ROOT+"?"+VAR_MODULE+"=DealOrder&"+VAR_ACTION+"=pay_incharge&id="+id;
	}
	function checkBaofooOrder(id){
		$.ajax({
			url:ROOT_PATH + "/baofoo_query.php?id="+id,
			dataType:"json",
			cache : true,
			success:function(result){
				if(result.status ==  1){
					if (result.SuccTime!="") {
						var msg = "订单号：" + result.TransID + "\n";
						msg += "金额：" + result.factMoney + "\n";
						msg += "交易时间：" + result.SuccTime + "\n";
						msg += "交易状态：" + result.CheckResult;
						alert(msg);
					}
					else{
						alert("查询失败或未支付的订单");
					}
				}
				else{
					alert("查询失败");
				}
			}
		});
	}
	function checkSqOrder(id){
		window.open(ROOT_PATH + "/95epay_adminquery.php?id="+id);
		
	}
	
	
	
	
	
</script>
<div class="main">
<div class="main_title">{%INCHARGE_ORDER}</div>
<div class="blank5"></div>

<div class="blank5"></div>
<div class="search_row">
	<form name="search" action="__APP__" method="get">	
		{%ORDER_SN}：<input type="text" class="textbox" name="order_sn" value="{:trim($_REQUEST['order_sn'])}" />
		{%USER_NAME}：<input type="text" class="textbox" name="user_name" value="{:trim($_REQUEST['user_name'])}" />
		支付状态：
		<select name="pay_status">
		<option value=""  selected="selected">所有</option>
		<option value="2" <if condition="intval($_REQUEST['pay_status']) eq 2"> selected="selected"</if>>支付</option>
		<option value="0" <if condition="$_REQUEST['pay_status'] eq 0"> selected="selected"</if>>未付</option>
	
		</select>
		<input type="hidden" value="DealOrder" name="m" />
		<input type="hidden" value="incharge_index" name="a" />
		<input type="submit" class="button" value="{%SEARCH}" />
	</form>
</div>
<div class="blank5"></div>
<html:list 
	id="dataTable" 
	style="dataTable" 
	name="incharge" 
	
	action="true" 
	datasource="list" 
	show="id:{%ID}|50px,order_sn:{%ORDER_SN},user_id|get_user_name:{%USER_NAME},user_id|get_real_name:真实姓名,deal_total_price|format_price:{%INCHARGE_AMOUNT},bank_id|get_bank:银行,pay_status|get_pay_status:{%PAYMENT_STATUS},create_time|to_date:创建时间|150px,memo:支付备注" 
	actionlist="id|get_pay_incharge_link,id|get_baofoo_query_link=$incharge['payment_id'],id|get_sqepay_query_link=$incharge['payment_id'], del:{%DEL}" /> 
	<!--收款,-->

<div class="blank5"></div>
<div class="page">{$page}</div>
</div>
<include file="Public:footer" />